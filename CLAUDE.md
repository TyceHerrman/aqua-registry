# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a fork of [aquaproj/aqua-registry](https://github.com/aquaproj/aqua-registry), the standard package registry for the [aqua](https://aquaproj.github.io/) CLI version manager. Packages are defined as YAML files under `pkgs/`.

## Commands

All commands use `cmdx` (installed via aqua). Run from the repo root.

### Adding a new package

```bash
cmdx s <org/repo>         # Scaffold: creates branch from upstream/main, generates files, tests in Docker
cmdx t <org/repo>         # Test: runs installation tests on Linux and Windows containers
cmdx new <org/repo>       # Create PR to upstream aquaproj/aqua-registry
```

### Other commands

```bash
cmdx gr                   # Regenerate root registry.yaml (auto-generated, never edit manually)
cmdx con <os> <arch>      # Connect to test container for debugging (e.g., cmdx con linux amd64)
cmdx start                # Start Docker containers
cmdx stop                 # Stop Docker containers
cmdx rm                   # Remove Docker containers
cmdx rmp <org/repo>       # Remove a package from containers
```

### Flags

- `cmdx s -r <pkg>` — recreate containers before scaffolding
- `cmdx s -l 1 <pkg>` — limit scaffold to 1 version (for non-github_release packages)
- `cmdx s -c config.yaml <pkg>` — use a custom scaffold config

## Architecture

### Package structure

Each package lives in `pkgs/<org>/<repo>/` with two files:

- **`registry.yaml`** — installation config (asset patterns, checksums, platform overrides, version constraints)
- **`pkg.yaml`** — lists versions used for testing
- **`scaffold.yaml`** (optional) — customizes auto-generation behavior for complex packages

### How scaffolding works

`cmdx s` runs inside Docker containers (`docker/Dockerfile`). The flow:

1. `scripts/checkout.sh` — creates `feat/<pkg>` branch from upstream main
2. `scripts/start.sh` — builds/starts Linux Docker container with aqua installed
3. `scripts/scaffold.sh` — runs `aqua gr` inside the container to generate registry.yaml and pkg.yaml
4. `scripts/commit.sh` — commits generated files
5. `scripts/test.sh` — tests `aqua i` for all platform combinations (linux/darwin × amd64/arm64)
6. `scripts/test-windows.sh` — tests on Windows container

### Root registry.yaml

The root `registry.yaml` (~2.9MB) is auto-generated by `cmdx gr` (which runs `aqua-registry gr`). It compiles all individual package registry.yaml files into one. **Never edit it manually.**

### Contributing guide

Follow [aquaproj.github.io/docs/products/aqua-registry/contributing](https://aquaproj.github.io/docs/products/aqua-registry/contributing). Key requirements:

- Must use `cmdx s` — manually written PRs are not accepted
- All commits must be signed
- PR title format: `feat: add <org/repo>`
- Complete the PR template checklist
- No force pushes after opening a PR
